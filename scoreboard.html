<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>×œ×•×— ×–×•×›×™× - ××›×•× ×ª ××–×œ 777</title>

    <!-- Google Fonts - Assistant for Hebrew -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Assistant:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Assistant', sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #0f0f1e 100%);
            color: white;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
            padding: 30px 20px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 20px;
            border: 2px solid rgba(255, 215, 0, 0.3);
        }

        .header h1 {
            font-size: 3em;
            font-weight: 800;
            background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 10px;
            text-shadow: 0 0 30px rgba(255, 215, 0, 0.5);
        }

        .header p {
            font-size: 1.2em;
            color: rgba(255, 255, 255, 0.7);
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 40px;
        }

        .stat-card {
            background: rgba(255, 255, 255, 0.05);
            padding: 20px;
            border-radius: 15px;
            border: 2px solid rgba(255, 215, 0, 0.2);
            text-align: center;
        }

        .stat-card .number {
            font-size: 2.5em;
            font-weight: 800;
            color: #FFD700;
            margin-bottom: 5px;
        }

        .stat-card .label {
            font-size: 1em;
            color: rgba(255, 255, 255, 0.6);
        }

        .winners-list {
            display: grid;
            gap: 15px;
        }

        .winner-card {
            background: rgba(255, 255, 255, 0.05);
            padding: 20px;
            border-radius: 15px;
            border: 2px solid rgba(255, 215, 0, 0.2);
            display: grid;
            grid-template-columns: auto 1fr auto auto;
            gap: 20px;
            align-items: center;
            transition: all 0.3s ease;
            animation: slideIn 0.5s ease;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(-20px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        .winner-card:hover {
            border-color: rgba(255, 215, 0, 0.5);
            transform: translateX(-5px);
            box-shadow: 0 5px 20px rgba(255, 215, 0, 0.3);
        }

        .winner-rank {
            font-size: 2em;
            font-weight: 800;
            color: #FFD700;
            min-width: 50px;
            text-align: center;
        }

        .winner-info {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .winner-name {
            font-size: 1.5em;
            font-weight: 700;
            color: white;
        }

        .winner-time {
            font-size: 0.9em;
            color: rgba(255, 255, 255, 0.5);
        }

        .winner-prize {
            display: flex;
            align-items: center;
            gap: 10px;
            background: rgba(255, 215, 0, 0.1);
            padding: 10px 20px;
            border-radius: 10px;
        }

        .prize-symbol {
            font-size: 2em;
        }

        .prize-name {
            font-size: 1.2em;
            font-weight: 600;
            color: #FFD700;
        }

        .trophy-icon {
            font-size: 2.5em;
        }

        .trophy-gold {
            color: #FFD700;
        }

        .trophy-silver {
            color: #C0C0C0;
        }

        .trophy-bronze {
            color: #CD7F32;
        }

        .loading {
            text-align: center;
            padding: 60px 20px;
            font-size: 1.5em;
            color: rgba(255, 255, 255, 0.5);
        }

        .no-winners {
            text-align: center;
            padding: 60px 20px;
            font-size: 1.5em;
            color: rgba(255, 255, 255, 0.5);
        }

        /* Footer with subtle links */
        .scoreboard-footer {
            text-align: center;
            padding: 30px 20px 40px;
            margin-top: 40px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        .footer-link {
            color: rgba(255, 255, 255, 0.6);
            text-decoration: none;
            font-size: 0.9em;
            font-weight: 500;
            transition: all 0.2s ease;
            padding: 5px 10px;
        }

        .footer-link:hover {
            color: rgba(255, 215, 0, 0.9);
            text-decoration: underline;
        }

        .footer-link-danger {
            color: rgba(255, 100, 100, 0.7);
        }

        .footer-link-danger:hover {
            color: rgba(255, 68, 68, 1);
        }

        .footer-separator {
            color: rgba(255, 255, 255, 0.3);
            margin: 0 10px;
        }

        /* Prize Statistics Styles */
        #prize-stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-bottom: 40px;
        }

        .prize-stat-card {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            border: 2px solid rgba(255, 215, 0, 0.2);
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .prize-stat-card:hover {
            border-color: rgba(255, 215, 0, 0.4);
            box-shadow: 0 5px 15px rgba(255, 215, 0, 0.2);
        }

        .prize-stat-header {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 20px;
            cursor: pointer;
            user-select: none;
            transition: background 0.2s ease;
        }

        .prize-stat-header:hover {
            background: rgba(255, 255, 255, 0.05);
        }

        .prize-stat-image {
            width: 60px;
            height: 60px;
            object-fit: cover;
            border-radius: 10px;
            border: 2px solid rgba(255, 215, 0, 0.3);
        }

        .prize-stat-symbol {
            font-size: 2.5em;
            width: 60px;
            height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(255, 215, 0, 0.1);
            border-radius: 10px;
        }

        .prize-stat-name {
            font-size: 1.2em;
            font-weight: 700;
            color: #FFD700;
        }

        .prize-stat-info {
            display: flex;
            flex-direction: column;
            gap: 8px;
            padding: 0 20px 20px 20px;
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.4s ease, padding 0.4s ease;
        }

        .prize-stat-info.expanded {
            max-height: 300px;
            padding: 0 20px 20px 20px;
        }

        .prize-stat-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.95em;
        }

        .prize-stat-label {
            color: rgba(255, 255, 255, 0.6);
        }

        .prize-stat-value {
            font-weight: 700;
            color: white;
        }

        .prize-stat-value.infinite {
            color: #4ade80;
        }

        .prize-stat-value.low {
            color: #ef4444;
        }

        .prize-stat-value.medium {
            color: #fbbf24;
        }

        .prize-progress-bar {
            width: 100%;
            height: 8px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
            overflow: hidden;
            margin-top: 10px;
        }

        .prize-progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #fbbf24 0%, #FFD700 100%);
            transition: width 0.3s ease;
        }

        .prize-progress-fill.low {
            background: linear-gradient(90deg, #ef4444 0%, #fca5a5 100%);
        }

        .prize-progress-fill.medium {
            background: linear-gradient(90deg, #fbbf24 0%, #fde047 100%);
        }

        .prize-progress-fill.high {
            background: linear-gradient(90deg, #4ade80 0%, #86efac 100%);
        }

        /* Mobile Responsive Styles */
        @media (max-width: 768px) {
            body {
                padding: 10px;
            }

            .header {
                padding: 20px 15px;
                margin-bottom: 20px;
            }

            .header h1 {
                font-size: 2em;
            }

            .header p {
                font-size: 1em;
            }

            /* Stats cards - 2 columns on mobile */
            .stats {
                grid-template-columns: repeat(2, 1fr);
                gap: 10px;
                margin-bottom: 20px;
            }

            .stat-card {
                padding: 15px 10px;
            }

            .stat-card .number {
                font-size: 2em;
            }

            .stat-card .label {
                font-size: 0.85em;
            }

            /* Prize stats header - smaller on mobile */
            .prize-stats-header h2 {
                font-size: 1.5em !important;
            }

            .prize-stats-header p {
                font-size: 0.85em !important;
            }

            /* Prize stats grid - single column on mobile */
            #prize-stats-grid {
                grid-template-columns: 1fr !important;
                gap: 10px;
            }

            .prize-stat-card {
                padding: 15px;
            }

            .prize-stat-image,
            .prize-stat-symbol {
                width: 50px;
                height: 50px;
            }

            .prize-stat-name {
                font-size: 1em;
            }

            .prize-stat-row {
                font-size: 0.9em;
            }

            /* Winner cards - stack on mobile */
            .winner-card {
                grid-template-columns: auto 1fr;
                gap: 10px;
                padding: 15px;
            }

            .winner-rank {
                font-size: 1.5em;
                min-width: 40px;
            }

            .winner-name {
                font-size: 1.2em;
            }

            .winner-time {
                font-size: 0.8em;
            }

            .winner-prize {
                grid-column: 1 / -1;
                padding: 10px 15px;
                margin-top: 5px;
            }

            .prize-symbol {
                font-size: 1.5em;
            }

            .prize-name {
                font-size: 1em;
            }

            .trophy-icon {
                display: none;
            }

            /* Footer - smaller text and stacked links */
            .scoreboard-footer {
                padding: 20px 10px 30px;
                margin-top: 30px;
            }

            .footer-link {
                font-size: 0.85em;
                padding: 3px 8px;
            }

            .footer-separator {
                margin: 0 5px;
            }
        }

        /* Extra small mobile devices */
        @media (max-width: 480px) {
            .header h1 {
                font-size: 1.5em;
            }

            .header p {
                font-size: 0.9em;
            }

            /* Stack stats vertically on very small screens */
            .stats {
                grid-template-columns: 1fr;
            }

            .stat-card .number {
                font-size: 1.8em;
            }

            .winner-card {
                padding: 12px;
            }

            .winner-rank {
                font-size: 1.3em;
                min-width: 35px;
            }

            .winner-name {
                font-size: 1.1em;
            }

            .prize-stat-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }

            .prize-stat-image,
            .prize-stat-symbol {
                width: 40px;
                height: 40px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ† ×œ×•×— ×”×–×•×›×™× ğŸ†</h1>
            <p>×¨×©×™××ª ×›×œ ×”×–×•×›×™× ×‘××›×•× ×ª ×”××–×œ ×©×œ× ×•!</p>
        </div>

        <div class="stats">
            <div class="stat-card">
                <div class="number" id="total-winners">0</div>
                <div class="label">×¡×š ×”×›×œ ×–×•×›×™×</div>
            </div>
            <div class="stat-card">
                <div class="number" id="today-winners">0</div>
                <div class="label">×–×•×›×™× ×”×™×•×</div>
            </div>
            <div class="stat-card">
                <div class="number" id="top-prize">-</div>
                <div class="label">×”×¤×¨×¡ ×”×¤×•×¤×•×œ×¨×™</div>
            </div>
        </div>

        <!-- Prize Inventory Statistics -->
        <div id="prize-stats-container" style="display: none;">
            <div class="header prize-stats-header-main" style="margin-top: 20px; margin-bottom: 20px; cursor: pointer; user-select: none;" onclick="toggleAllPrizeStats()">
                <h2 style="font-size: 2em;">
                    ğŸ ×¡×˜×˜×™×¡×˜×™×§×•×ª ×¤×¨×¡×™×
                </h2>
                <p style="font-size: 1em;">×œ×—×¥ ×›×“×™ ×œ×”×¦×™×’/×œ×”×¡×ª×™×¨ â€¢ ×œ×—×¥ ×¢×œ ×›×œ ×¤×¨×¡ ×œ×¤×¨×˜×™× × ×•×¡×¤×™×</p>
            </div>
            <div id="prize-stats-grid" style="max-height: 0; overflow: hidden; transition: max-height 0.5s ease, opacity 0.3s ease; opacity: 0;"></div>
        </div>

        <div id="winners-container">
            <div class="loading">â³ ×˜×•×¢×Ÿ × ×ª×•× ×™×...</div>
        </div>

        <!-- Footer with subtle links -->
        <div class="scoreboard-footer">
            <a href="index.html" class="footer-link">×—×–×¨×” ×œ××©×—×§</a>
            <span class="footer-separator">â€¢</span>
            <a href="javascript:void(0)" onclick="location.reload()" class="footer-link">×¨×¢× ×Ÿ</a>
            <span class="footer-separator">â€¢</span>
            <a href="javascript:void(0)" onclick="resetScoreboard()" class="footer-link footer-link-danger">××¤×¡ ×œ×•×—</a>
        </div>
    </div>

    <script src="firebase-config.js"></script>
    <script>
        let winnersData = [];
        let currentSessionId = null;
        let prizeInventoryData = []; // ××œ××™ ×”×¤×¨×¡×™×

        // Get sessionId from URL or localStorage
        function getSessionId() {
            // Try URL parameter first
            const urlParams = new URLSearchParams(window.location.search);
            const sessionFromUrl = urlParams.get('session');

            if (sessionFromUrl) {
                // Save to localStorage for next time
                localStorage.setItem('currentSessionId', sessionFromUrl);
                return sessionFromUrl;
            }

            // Try localStorage
            const sessionFromStorage = localStorage.getItem('currentSessionId');
            if (sessionFromStorage) {
                return sessionFromStorage;
            }

            return null;
        }

        // ×˜×¢×Ÿ × ×ª×•× ×™ ××œ××™ ×¤×¨×¡×™× ×-Firebase
        async function loadPrizeInventory() {
            if (!currentSessionId) {
                console.warn('âš ï¸ ××™×Ÿ sessionId - ×œ× × ×™×ª×Ÿ ×œ×˜×¢×•×Ÿ ××œ××™ ×¤×¨×¡×™×');
                return false;
            }

            try {
                // ×˜×¢×Ÿ ×-Firebase (×¢×“×›× ×™)
                const prizesRef = firebase.database().ref(`sessions/${currentSessionId}/prizes`);
                const snapshot = await prizesRef.once('value');
                const prizesData = snapshot.val();

                console.log('ğŸ” Raw Firebase data:', prizesData);

                if (prizesData) {
                    // ×”××¨ ×××•×‘×™×™×§×˜ ×œ××¢×¨×š
                    prizeInventoryData = Object.values(prizesData).map((prize, idx) => {
                        console.log(`ğŸ“¦ Processing prize #${idx}:`, prize);

                        // × ×¡×” ×œ××¦×•× ××ª ×©× ×”×¤×¨×¡ ×××§×•××•×ª ×©×•× ×™×
                        const prizeName = prize.prizeName || prize.name || prize.label || `×¤×¨×¡ ${idx + 1}`;

                        const prizeData = {
                            id: Date.now() + Math.random(),
                            code: prize.code,
                            imageData: prize.imageUrl || prize.imageData,
                            inventory: prize.inventory !== undefined ? prize.inventory : null,
                            initialInventory: prize.initialInventory !== undefined ? prize.initialInventory : null,
                            distributedCount: prize.distributedCount || 0,
                            label: prizeName,
                            name: prizeName,
                            prizeName: prizeName,
                            symbolIndex: prize.symbolIndex
                        };

                        console.log(`âœ… Mapped prize #${idx}:`, prizeData);
                        return prizeData;
                    });

                    console.log('â˜ï¸ × ×˜×¢× ×• × ×ª×•× ×™ ××œ××™ ×-Firebase:', prizeInventoryData.length, '×¤×¨×¡×™×');
                    console.log('ğŸ“Š Prize inventory data:', prizeInventoryData);
                    return true;
                } else {
                    console.log('ğŸ“­ ××™×Ÿ × ×ª×•× ×™ ×¤×¨×¡×™× ×‘-Firebase');
                    return false;
                }
            } catch (e) {
                console.error('âŒ ×©×’×™××” ×‘×˜×¢×™× ×ª × ×ª×•× ×™ ××œ××™:', e);
                return false;
            }
        }

        // ×—×©×‘ ×¡×˜×˜×™×¡×˜×™×§×•×ª ××”×–×•×›×™× (×× ××™×Ÿ × ×ª×•× ×™ ××œ××™)
        function calculateStatsFromWinners() {
            const prizeCount = {};

            console.log('ğŸ” ××—×©×‘ ×¡×˜×˜×™×¡×˜×™×§×•×ª ×-', winnersData.length, '×–×•×›×™×');

            // ×¢×‘×•×¨ ×¢×œ ×›×œ ×”×–×•×›×™× ×•×¡×¤×•×¨ ×›××” ×¤×¢××™× ×›×œ ×¤×¨×¡ ×—×•×œ×§
            winnersData.forEach(winner => {
                const prizeName = winner.prizeName || winner.prize || '×¤×¨×¡ ×œ× ×™×“×•×¢';
                // × ×¡×” ×œ××¦×•× ××ª ×”×ª××•× ×” ×‘×›×œ ×”××§×•××•×ª ×”××¤×©×¨×™×™×
                const prizeImage = winner.prizeImage || winner.prizeSymbol || winner.symbol || null;

                console.log(`ğŸ“¦ Winner: ${winner.playerName}, Prize: ${prizeName}, Image:`, prizeImage ? '×™×© ×ª××•× ×”' : '××™×Ÿ ×ª××•× ×”');

                if (!prizeCount[prizeName]) {
                    prizeCount[prizeName] = {
                        name: prizeName,
                        distributed: 0,
                        imageData: prizeImage,
                        totalPrizes: null,
                        remaining: null
                    };
                } else {
                    // ×¢×“×›×Ÿ ×ª××•× ×” ×× ×¢×“×™×™×Ÿ ××™×Ÿ ××• ×× ×™×© ×ª××•× ×” ×—×“×©×” ×™×•×ª×¨
                    if (!prizeCount[prizeName].imageData && prizeImage) {
                        prizeCount[prizeName].imageData = prizeImage;
                    }
                }
                prizeCount[prizeName].distributed++;
            });

            console.log('ğŸ“Š Prize count:', prizeCount);

            // ×”××¨ ×œ×¤×•×¨××˜ ×”× ×“×¨×© - ×× ××™×Ÿ × ×ª×•× ×™ ××œ××™, ×¤×©×•×˜ ×”×¦×’ ×›××” ×—×•×œ×§
            return Object.values(prizeCount).map(prize => ({
                name: prize.name,
                imageData: prize.imageData,
                totalPrizes: '?',  // ×œ× ×™×“×•×¢ - ××™×Ÿ × ×ª×•× ×™ Firebase
                distributed: prize.distributed,
                remaining: '?',  // ×œ× ×™×“×•×¢ - ××™×Ÿ × ×ª×•× ×™ Firebase
                percentRemaining: 0,
                isInfinite: false  // ×œ× ×‘×œ×ª×™ ××•×’×‘×œ, ×¤×©×•×˜ ×œ× ×™×“×•×¢
            }));
        }

        // ×—×©×‘ ×¡×˜×˜×™×¡×˜×™×§×•×ª ×œ×›×œ ×¤×¨×¡
        function calculatePrizeStats() {
            // ×× ××™×Ÿ × ×ª×•× ×™ ××œ××™, ×—×©×‘ ××”×–×•×›×™×
            if (prizeInventoryData.length === 0) {
                console.log('âš ï¸ ××™×Ÿ × ×ª×•× ×™ ××œ××™ - ××©×ª××© ×‘×—×™×©×•×‘ ××–×•×›×™×');
                return calculateStatsFromWinners();
            }

            console.log('âœ… ××©×ª××© ×‘× ×ª×•× ×™ ××œ××™ ×-Firebase');

            return prizeInventoryData.map((prize, index) => {
                const totalPrizes = prize.initialInventory; // ×›××•×ª ×”×ª×—×œ×ª×™×ª
                const distributed = prize.distributedCount || 0; // ×›××” ×—×•×œ×§
                const remaining = prize.inventory; // ×›××” × ×©××¨

                // ×—×©×‘ ××—×•×– × ×•×ª×¨
                let percentRemaining = 100;
                if (totalPrizes !== null && totalPrizes > 0) {
                    percentRemaining = Math.round((remaining / totalPrizes) * 100);
                }

                // × ×¡×” ×œ××¦×•× ××ª ×©× ×”×¤×¨×¡ ×××¡×¤×¨ ××§×•××•×ª ××¤×©×¨×™×™×
                const prizeName = prize.prizeName || prize.label || prize.name || `×¤×¨×¡ ${index + 1}`;

                const stats = {
                    name: prizeName,
                    imageData: prize.imageData,
                    totalPrizes: totalPrizes === null ? 'âˆ' : totalPrizes,
                    distributed: distributed,
                    remaining: remaining === null ? 'âˆ' : remaining,
                    percentRemaining: percentRemaining,
                    isInfinite: prize.inventory === null
                };

                console.log(`ğŸ“Š Prize stats for "${stats.name}":`, stats);
                console.log(`ğŸ“¦ Original prize data:`, prize);
                return stats;
            });
        }

        // ×”×¦×’ ×¡×˜×˜×™×¡×˜×™×§×•×ª ×¤×¨×¡×™×
        function displayPrizeStats() {
            const prizeStats = calculatePrizeStats();

            console.log('ğŸ“Š Total prize stats:', prizeStats.length);

            if (prizeStats.length === 0) {
                // ××™×Ÿ × ×ª×•× ×™ ××œ××™ ×•××™×Ÿ ×–×•×›×™× - ×”×¡×ª×¨ ××ª ×”×¡×§×©×Ÿ
                document.getElementById('prize-stats-container').style.display = 'none';
                console.log('âš ï¸ ××¡×ª×™×¨ ×¡×˜×˜×™×¡×˜×™×§×•×ª ×¤×¨×¡×™× - ××™×Ÿ × ×ª×•× ×™×');
                return;
            }

            // ×”×¦×’ ××ª ×”×¡×§×©×Ÿ
            document.getElementById('prize-stats-container').style.display = 'block';
            console.log('âœ… ××¦×™×’ ×¡×˜×˜×™×¡×˜×™×§×•×ª ×¤×¨×¡×™×');

            const container = document.getElementById('prize-stats-grid');

            const html = prizeStats.map((prize, index) => {
                // ×§×‘×¢ ×¡×•×’ ×¦×‘×¢ ×œ×¤×™ ××—×•×– × ×•×ª×¨
                let valueClass = '';
                let progressClass = 'high';

                if (prize.isInfinite) {
                    valueClass = 'infinite';
                    progressClass = 'high';
                } else {
                    if (prize.percentRemaining <= 20) {
                        valueClass = 'low';
                        progressClass = 'low';
                    } else if (prize.percentRemaining <= 50) {
                        valueClass = 'medium';
                        progressClass = 'medium';
                    }
                }

                // ×‘×“×•×§ ×× ×™×© ×ª××•× ×”
                const imageHTML = prize.imageData
                    ? `<img src="${prize.imageData}" alt="${prize.name}" class="prize-stat-image">`
                    : `<div class="prize-stat-symbol">ğŸ</div>`;

                return `
                    <div class="prize-stat-card" data-prize-index="${index}">
                        <div class="prize-stat-header" onclick="togglePrizeDetails(${index})">
                            ${imageHTML}
                            <div class="prize-stat-name">${prize.name}</div>
                        </div>
                        <div class="prize-stat-info" id="prize-info-${index}">
                            <div class="prize-stat-row">
                                <span class="prize-stat-label">×¡×”×´×› ×¤×¨×¡×™×:</span>
                                <span class="prize-stat-value ${prize.isInfinite ? 'infinite' : ''}">${prize.totalPrizes}</span>
                            </div>
                            <div class="prize-stat-row">
                                <span class="prize-stat-label">×—×•×œ×§:</span>
                                <span class="prize-stat-value">${prize.distributed}</span>
                            </div>
                            <div class="prize-stat-row">
                                <span class="prize-stat-label">× ×©××¨:</span>
                                <span class="prize-stat-value ${valueClass}">${prize.remaining}</span>
                            </div>
                            ${!prize.isInfinite && prize.totalPrizes !== '?' ? `
                                <div class="prize-progress-bar">
                                    <div class="prize-progress-fill ${progressClass}" style="width: ${prize.percentRemaining}%"></div>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                `;
            }).join('');

            container.innerHTML = html;
        }

        // Load and display winners
        async function loadWinners() {
            try {
                currentSessionId = getSessionId();

                if (!currentSessionId) {
                    document.getElementById('winners-container').innerHTML =
                        '<div class="no-winners">âš ï¸ ×œ× × ××¦× ××–×”×” ××©×—×§<br><br>×¤×ª×— ××ª ×”×œ×•×— ×“×¨×š ×”××©×—×§ ××• ×”×•×¡×£ ?session=SESSION_ID ×œ×›×ª×•×‘×ª</div>';
                    return;
                }

                console.log(`ğŸ“Š Loading winners for session: ${currentSessionId}`);

                const winnersRef = firebase.database().ref(`sessions/${currentSessionId}/winners`);

                winnersRef.on('value', (snapshot) => {
                    const data = snapshot.val();
                    winnersData = [];

                    if (data) {
                        // ×”××¨ ×œ××¨×™×™ ×•×××™×™×Ÿ ×œ×¤×™ ×–××Ÿ (×”×—×“×© ×‘×™×•×ª×¨ ×§×•×“×)
                        Object.entries(data).forEach(([key, winner]) => {
                            winnersData.push({
                                id: key,
                                ...winner
                            });
                        });

                        winnersData.sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0));
                    }

                    displayWinners();
                    updateStats();
                    // ×¢×“×›×Ÿ ×’× ×¡×˜×˜×™×¡×˜×™×§×•×ª ×¤×¨×¡×™×
                    displayPrizeStats();
                });

                console.log('âœ… Winners listener set up for session');
            } catch (error) {
                console.error('âŒ Error loading winners:', error);
                document.getElementById('winners-container').innerHTML =
                    '<div class="no-winners">âŒ ×©×’×™××” ×‘×˜×¢×™× ×ª × ×ª×•× ×™×</div>';
            }
        }

        // Display winners list
        function displayWinners() {
            const container = document.getElementById('winners-container');

            if (winnersData.length === 0) {
                container.innerHTML = '<div class="no-winners">ğŸ° ×¢×“×™×™×Ÿ ××™×Ÿ ×–×•×›×™×. ×”×™×• ×”×¨××©×•× ×™×!</div>';
                return;
            }

            const html = `
                <div class="winners-list">
                    ${winnersData.map((winner, index) => {
                        const rank = index + 1;
                        let trophyClass = '';
                        let trophyIcon = 'ğŸ…';

                        if (rank === 1) {
                            trophyClass = 'trophy-gold';
                            trophyIcon = 'ğŸ¥‡';
                        } else if (rank === 2) {
                            trophyClass = 'trophy-silver';
                            trophyIcon = 'ğŸ¥ˆ';
                        } else if (rank === 3) {
                            trophyClass = 'trophy-bronze';
                            trophyIcon = 'ğŸ¥‰';
                        }

                        const timeStr = formatTime(winner.timestamp);

                        // ×‘×“×•×§ ×× prizeSymbol ×”×•× ×ª××•× ×” (data:image ××• blob:)
                        const isImage = winner.prizeSymbol &&
                                       (winner.prizeSymbol.includes('data:image') ||
                                        winner.prizeSymbol.includes('blob:'));

                        const prizeSymbolHTML = isImage
                            ? `<img src="${winner.prizeSymbol}" alt="${winner.prizeName || '×¤×¨×¡'}" style="width: 60px; height: 60px; object-fit: cover; border-radius: 10px;">`
                            : `<div class="prize-symbol">${winner.prizeSymbol || 'ğŸ'}</div>`;

                        return `
                            <div class="winner-card">
                                <div class="winner-rank">#${rank}</div>
                                <div class="winner-info">
                                    <div class="winner-name">${winner.playerName || '×œ×—×¥ ×‘×‘××–×¨'}</div>
                                    <div class="winner-time">${timeStr}</div>
                                </div>
                                <div class="winner-prize">
                                    ${prizeSymbolHTML}
                                    <div class="prize-name">${winner.prizeName || '×¤×¨×¡'}</div>
                                </div>
                                <div class="trophy-icon ${trophyClass}">${trophyIcon}</div>
                            </div>
                        `;
                    }).join('')}
                </div>
            `;

            container.innerHTML = html;
        }

        // Update statistics
        function updateStats() {
            // Total winners
            document.getElementById('total-winners').textContent = winnersData.length;

            // Today's winners
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const todayTimestamp = today.getTime();

            const todayWinners = winnersData.filter(w => (w.timestamp || 0) >= todayTimestamp);
            document.getElementById('today-winners').textContent = todayWinners.length;

            // Top prize
            if (winnersData.length > 0) {
                const prizeCounts = {};
                winnersData.forEach(w => {
                    const prize = w.prizeName || '×¤×¨×¡';
                    prizeCounts[prize] = (prizeCounts[prize] || 0) + 1;
                });

                const topPrize = Object.entries(prizeCounts)
                    .sort((a, b) => b[1] - a[1])[0];

                document.getElementById('top-prize').textContent = topPrize[0];
            } else {
                document.getElementById('top-prize').textContent = '-';
            }

            // ×”×¤×¢×œ ×× ×™××¦×™×•×ª ××¡×¤×¨×™×
            animateStats();
        }

        // Format timestamp to readable string
        function formatTime(timestamp) {
            if (!timestamp) return '×œ× ×™×“×•×¢';

            const date = new Date(timestamp);

            // ×ª××¨×™×š ×•×©×¢×” ××œ××™× ×‘×¢×‘×¨×™×ª
            const dateStr = date.toLocaleDateString('he-IL', {
                day: 'numeric',
                month: 'numeric',
                year: 'numeric'
            });

            const timeStr = date.toLocaleTimeString('he-IL', {
                hour: '2-digit',
                minute: '2-digit'
            });

            return `${dateStr} ${timeStr}`;
        }

        // Initialize on page load
        window.addEventListener('DOMContentLoaded', async () => {
            console.log('ğŸ† Scoreboard page loaded');

            // Wait for Firebase to be ready
            if (typeof firebase === 'undefined') {
                console.error('âŒ Firebase not loaded');
                document.getElementById('winners-container').innerHTML =
                    '<div class="no-winners">âŒ ×©×’×™××” ×‘×˜×¢×™× ×ª Firebase</div>';
                return;
            }

            // Initialize Firebase if not already initialized
            if (!firebase.apps || firebase.apps.length === 0) {
                try {
                    firebase.initializeApp({
                        apiKey: "AIzaSyCGXQPoawVk-hWU_-XPIpIOb3_8Yk5GVQY",
                        authDomain: "slotm-c0090.firebaseapp.com",
                        databaseURL: "https://slotm-c0090-default-rtdb.firebaseio.com",
                        projectId: "slotm-c0090",
                        storageBucket: "slotm-c0090.firebasestorage.app",
                        messagingSenderId: "578201903364",
                        appId: "1:578201903364:web:c6a9a2ac8da5491f60b051",
                        measurementId: "G-3MCERX9P1E"
                    });
                    console.log('âœ… Firebase initialized for scoreboard');
                } catch (error) {
                    console.error('âŒ Firebase initialization error:', error);
                    document.getElementById('winners-container').innerHTML =
                        '<div class="no-winners">âŒ ×©×’×™××” ×‘××ª×—×•×œ Firebase</div>';
                    return;
                }
            }

            // ×˜×¢×Ÿ ×ª×—×™×œ×” ××ª sessionId ×“×¨×š loadWinners, ×•××– ×˜×¢×Ÿ ××ª ××œ××™ ×”×¤×¨×¡×™×
            currentSessionId = getSessionId();

            // ×˜×¢×Ÿ × ×ª×•× ×™ ××œ××™ ×¤×¨×¡×™× ×•×”×¦×’ ×¡×˜×˜×™×¡×˜×™×§×•×ª
            await loadPrizeInventory();
            displayPrizeStats();

            loadWinners();
        });

        // Toggle all prize stats visibility (main header)
        function toggleAllPrizeStats() {
            const grid = document.getElementById('prize-stats-grid');

            if (grid.style.maxHeight === '0px' || grid.style.maxHeight === '') {
                // ×¤×ª×— - ×”×¦×’ ××ª ×”×’×¨×™×“
                grid.style.maxHeight = '3000px'; // ×’×•×‘×” ××§×¡×™××œ×™ ×’×“×•×œ ××¡×¤×™×§
                grid.style.opacity = '1';
            } else {
                // ×¡×’×•×¨ - ×”×¡×ª×¨ ××ª ×”×’×¨×™×“
                grid.style.maxHeight = '0px';
                grid.style.opacity = '0';
            }
        }

        // Toggle individual prize details
        function togglePrizeDetails(index) {
            const infoElement = document.getElementById(`prize-info-${index}`);

            if (infoElement.classList.contains('expanded')) {
                infoElement.classList.remove('expanded');
            } else {
                infoElement.classList.add('expanded');
            }
        }

        // ×× ×™××¦×™×” ×©×œ ××¡×¤×¨×™× ×¨×¦×™×
        function animateNumber(element, target, duration = 1000) {
            const start = 0;
            const startTime = performance.now();

            function update(currentTime) {
                const elapsed = currentTime - startTime;
                const progress = Math.min(elapsed / duration, 1);

                // easing function (ease-out)
                const easeOut = 1 - Math.pow(1 - progress, 3);
                const current = Math.floor(start + (target - start) * easeOut);

                element.textContent = current;

                if (progress < 1) {
                    requestAnimationFrame(update);
                } else {
                    element.textContent = target; // ×•×“× ×©×”××¡×¤×¨ ×”×¡×•×¤×™ ××“×•×™×§
                }
            }

            requestAnimationFrame(update);
        }

        // ×”×¤×¢×œ×ª ×× ×™××¦×™×•×ª ××¡×¤×¨×™× ×‘×¡×˜×˜×™×¡×˜×™×§×•×ª
        function animateStats() {
            // ×× ×™××¦×™×” ×œ×›×¨×˜×™×¡×™ ×¡×˜×˜×™×¡×˜×™×§×•×ª ×¢×œ×™×•× ×™×
            const totalWinners = parseInt(document.getElementById('total-winners').textContent) || 0;
            const todayWinners = parseInt(document.getElementById('today-winners').textContent) || 0;

            if (totalWinners > 0) {
                animateNumber(document.getElementById('total-winners'), totalWinners, 1500);
            }
            if (todayWinners > 0) {
                animateNumber(document.getElementById('today-winners'), todayWinners, 1200);
            }
        }

        // Reset scoreboard with confirmation
        async function resetScoreboard() {
            if (!currentSessionId) {
                alert('âŒ ×œ× × ××¦× ××–×”×” ××©×—×§');
                return;
            }

            // Ask for confirmation
            const confirmed = confirm('âš ï¸ ×”×× ××ª× ×‘×˜×•×—×™× ×©××ª× ×¨×•×¦×™× ×œ××¤×¡ ××ª ×›×œ ×œ×•×— ×”×–×•×›×™×?\n\n×¤×¢×•×œ×” ×–×• ×ª××—×§ ××ª ×›×œ ×”× ×ª×•× ×™× ×•×œ× × ×™×ª×Ÿ ×œ×©×—×–×¨×!');

            if (!confirmed) {
                console.log('âŒ ××™×¤×•×¡ ×œ×•×— ×‘×•×˜×œ');
                return;
            }

            try {
                console.log(`ğŸ—‘ï¸ ×××¤×¡ ×œ×•×— ×–×•×›×™× ×¢×‘×•×¨ session: ${currentSessionId}`);

                // Delete all winners data
                const winnersRef = firebase.database().ref(`sessions/${currentSessionId}/winners`);
                await winnersRef.remove();

                console.log('âœ… ×œ×•×— ×”×–×•×›×™× ××•×¤×¡ ×‘×”×¦×œ×—×”!');
                alert('âœ… ×œ×•×— ×”×–×•×›×™× ××•×¤×¡ ×‘×”×¦×œ×—×”!');

                // Reload the page to show empty state
                location.reload();
            } catch (error) {
                console.error('âŒ ×©×’×™××” ×‘××™×¤×•×¡ ×œ×•×— ×”×–×•×›×™×:', error);
                alert('âŒ ×©×’×™××” ×‘××™×¤×•×¡ ×œ×•×— ×”×–×•×›×™×. × ×¡×• ×©×•×‘.');
            }
        }

        // KEYBOARD SHORTCUT: ×’/G/D to return to game
        document.addEventListener('keydown', (e) => {
            if (e.key === '×’' || e.key === 'd' || e.key === 'D' || e.key === 'g' || e.key === 'G') {
                e.preventDefault();
                console.log('ğŸ° ×—×•×–×¨ ×œ××¡×š ××©×—×§ ××œ×•×— ×”×–×•×›×™×');

                // Get sessionId to preserve it in URL
                const currentSessionId = getSessionId();
                if (currentSessionId) {
                    window.location.href = `index.html?session=${currentSessionId}`;
                } else {
                    window.location.href = 'index.html';
                }
            }
        });

        console.log('âŒ¨ï¸ ×œ×—×¥ ×’/G/D ×›×“×™ ×œ×—×–×•×¨ ×œ××¡×š ×”××©×—×§');
    </script>
</body>
</html>
